#pragma once

#include "display.hpp"
#include "system.hpp"
#include "stripFrame.hpp"

constexpr uint8_t bitmap_test[] = {
	0xf8, 0x7f, 0xfe, 0x1f, 0xff, 0xfb, 0xff, 0xf0, 0xc5, 0x07, 0xfe, 0xdf, 0xff, 0xfb, 0xff, 0xf0, 
	0xfd, 0xff, 0xfe, 0xdf, 0xff, 0xfb, 0xff, 0xf0, 0xfd, 0xff, 0xfe, 0xdf, 0xff, 0xe0, 0x3f, 0xf0, 
	0xfd, 0xff, 0xfc, 0x9f, 0xcf, 0xfb, 0xbf, 0xf0, 0xfe, 0xff, 0xfc, 0x3f, 0x1f, 0xfb, 0xff, 0xf0, 
	0xfe, 0xff, 0xfd, 0xff, 0x7f, 0xfb, 0xff, 0xf0, 0xfe, 0xff, 0xfd, 0xfe, 0x7f, 0xfb, 0xff, 0xf0, 
	0xfe, 0xff, 0xf9, 0xfc, 0xff, 0xf7, 0xff, 0xf0, 0xfe, 0xff, 0xfb, 0xfd, 0xff, 0xf7, 0xff, 0xf0, 
	0xfe, 0xff, 0xfb, 0xf5, 0xff, 0xf7, 0xff, 0xf0, 0xfe, 0xff, 0xfb, 0xe5, 0xff, 0xf7, 0xff, 0xf0, 
	0xfe, 0xff, 0xfb, 0xf5, 0xff, 0xf7, 0xff, 0xf0, 0xfe, 0xff, 0xfd, 0xf1, 0xff, 0xf7, 0xff, 0xf0, 
	0xff, 0xff, 0xfc, 0xf9, 0xff, 0xf7, 0xff, 0xf0, 0xff, 0xc0, 0x7e, 0x39, 0xff, 0xf7, 0xff, 0xf0, 
	0x00, 0x3f, 0x3f, 0xfd, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xdf, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xfe, 0x7f, 0xef, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xfe, 0x7f, 0xe7, 0xff, 0xe0, 0x7f, 0xff, 0xf0, 
	0xfe, 0xff, 0xf3, 0xff, 0x0f, 0x1f, 0xff, 0xf0, 0xff, 0xff, 0xf9, 0xf8, 0x7f, 0xc7, 0xff, 0xf0, 
	0xfd, 0xff, 0xfc, 0x03, 0xff, 0xf3, 0xff, 0xf0, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xff, 0xf0, 
	0xfb, 0xfe, 0x3f, 0xff, 0xff, 0xfc, 0xff, 0x80, 0xf7, 0xfc, 0x9f, 0xff, 0xff, 0xfe, 0x1c, 0x30, 
	0xf7, 0xfb, 0xdf, 0xff, 0xff, 0xff, 0xc1, 0xf0, 0xf7, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xf7, 0xe7, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xf0, 0xf7, 0xcf, 0xff, 0xff, 0x90, 0xff, 0xff, 0xf0, 
	0xe7, 0xdf, 0xff, 0xff, 0x06, 0xfb, 0xff, 0xf0, 0xef, 0xdf, 0xff, 0xf8, 0x7e, 0xfb, 0xcf, 0xf0, 
	0xef, 0xdf, 0xff, 0xfe, 0xfe, 0xfd, 0x8f, 0xf0, 0xef, 0xdf, 0xff, 0xfc, 0xfe, 0xfc, 0x37, 0xf0, 
	0xef, 0xef, 0xff, 0xf9, 0xfd, 0xfc, 0x73, 0xf0, 0xef, 0xe7, 0xff, 0xfb, 0xfd, 0xfc, 0x7b, 0xf0, 
	0xef, 0xf1, 0xff, 0xf7, 0xfd, 0xfc, 0x7b, 0xf0, 0xe7, 0xfe, 0x7d, 0xe7, 0xfb, 0xfc, 0xfb, 0xf0, 
	0xff, 0xff, 0x01, 0xef, 0xf3, 0xfc, 0xfb, 0xf0, 0xff, 0xff, 0xff, 0xef, 0xc7, 0xfc, 0xfb, 0xf0, 
	0xff, 0xff, 0xff, 0xee, 0x1f, 0xfc, 0xfb, 0xf0, 0xff, 0xff, 0xff, 0xe0, 0xff, 0xfd, 0xfb, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xfb, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xfb, 0xf0
};

class HysteresisFilter {
private:
    float _threshold; // Threshold for minimum change
    float _min;
    float _max;
    float _previous;
public:
    HysteresisFilter(float threshold, float min, float max) : _threshold(threshold), _min(min), _max(max), _previous(min){}

    float filter(float input) {
        input = std::clamp(input, _min, _max);
        if(input < (_min + _threshold)){
            _previous = _min;
        }else if(input > (_max - _threshold)){
            _previous = _max;
        }
        
        if(std::abs(input - _previous) > _threshold) {
            _previous = input;
            return input;
        }else{
            return _previous;
        }
    }
};

class  Slider{
    adc_oneshot_unit_handle_t*    _adc_handle;
    adc_cali_handle_t               _adc_cali;
    
    // For calibration
    uint8_t _ico_buffer[64*64/8];
    uint16_t _ico_size_x = 0;
    uint16_t _ico_size_y = 0;
    bool _ico_display = false;

    float _position_filter_buff[11];
    size_t _position_filter_buff_idx = 0;

    struct calibration_t{
        float max_value;
        float min_value;
        float mid_value;
    };

    struct config_t{
        int16_t pin_scl                     =             -1;
        int16_t pin_sda                     =             -1;
        uint8_t i2c_addr                    =           0x3C;
        adc_channel_t adc_channel           =  ADC_CHANNEL_0;
        CRGB *led_strip                     =        nullptr;
        uint16_t led_start                  =              0;
        uint16_t led_count                  =              0;
        bool double_leds                    =           true;
    };
    float adcRawReadAccuracy( void );
    HysteresisFilter histFilter;
public:
    Slider( void ) : histFilter(0.01f, 0.0f, 1.0f) {}

    LGFX_SSD1306 display;
    StripFrame strip;
    const config_t& config( void ) const { return _cfg; }
    void config( const config_t& cfg );

    calibration_t calibrationGet( void ) { return _calibration; }
    void calibrationSetMinPoint( calibration_t& calibration ) { calibration.min_value = adcRawReadAccuracy(); }
    void calibrationSetMidPoint( calibration_t& calibration ) { calibration.mid_value = adcRawReadAccuracy(); }
    void calibrationSetMaxPoint( calibration_t& calibration ) { calibration.max_value = adcRawReadAccuracy(); }
    void calibrationLoad( const calibration_t calibration ) { _calibration = calibration; }

    int32_t init( adc_oneshot_unit_handle_t* adc_handle );
    int32_t setIcon( const uint8_t *icon, uint32_t size_x, uint32_t size_y );
    bool displayIcon( bool display_icon );
    bool displayIcon( void );
    void updatePosition( void );
    void updateDisplay( void );

    float adcFilteredRead( void );
    float adcRawRead( void );
    float readPosition( void );
    bool readButton( void );
protected:
    config_t _cfg;
    calibration_t _calibration;
};
